<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FSAI ROI Calculator</title>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="../src/index.css">
</head>

<body>

  <div id="roi-calculator-root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    const ROICalculator = () => {
      const [leadsPackage, setLeadsPackage] = useState('5555');
      const [conversionRate, setConversionRate] = useState(3);
      const [closeRate, setCloseRate] = useState(30);
      const [profitPerLead, setProfitPerLead] = useState(1000);
      const [leadsPerDay, setLeadsPerDay] = useState(100);
      const [retentionRate, setRetentionRate] = useState(80);
      const [monthlyRetainer, setMonthlyRetainer] = useState(0);
      const [stats, setStats] = useState({});
      // add custom leads and cost
      const [customLeads, setCustomLeads] = useState(500); // Default to 500
      const [customCost, setCustomCost] = useState(300); // Default to 300
      const chartRef = useRef(null);
      const chartInstance = useRef(null);
      const [chartRange, setChartRange] = useState(30); // Default to 30 days

      const calculateForDays = useCallback((days) => {

        // theres something wrong with this and I'm not sure what,
        // custom leads do not show up as input in the form, but the value is there
        const totalLeads = leadsPackage === 'custom' ? customLeads : parseInt(leadsPackage) || 0;
        const initialCost = leadsPackage === 'custom' ? customCost : (leadsPackage === '5555' ? 10000 : 2000);
        const commissionRate = 10;


        const safeConversionRate = Number(conversionRate) || 0;
        const safeCloseRate = Number(closeRate) || 0;
        const safeProfitPerLead = Number(profitPerLead) || 0;
        const safeLeadsPerDay = Number(leadsPerDay) || 1;
        const safeRetentionRate = Number(retentionRate) || 0;
        const safeMonthlyRetainer = Number(monthlyRetainer) || 0;

        let cumulativeProfit = -initialCost;
        let remainingLeads = totalLeads;
        let customersServed = 0;
        let activeCustomers = 0;
        let monthsPassed = 0;

        for (let day = 1; day <= days; day++) {
          if (remainingLeads > 0) {
            const leadsUsed = Math.min(remainingLeads, safeLeadsPerDay);
            const newConversions = leadsUsed * (safeConversionRate / 100) * (safeCloseRate / 100);
            const dailyNewProfit = newConversions * safeProfitPerLead;
            cumulativeProfit += dailyNewProfit;
            remainingLeads -= leadsUsed;
            customersServed += newConversions;
            activeCustomers += newConversions;
          }

          const dailyRetainedRevenue = (activeCustomers * safeProfitPerLead * (safeRetentionRate / 100)) / 30;
          cumulativeProfit += dailyRetainedRevenue;

          if (day % 30 === 0) {
            cumulativeProfit -= safeMonthlyRetainer;
            monthsPassed++;
            activeCustomers = Math.floor(activeCustomers * (safeRetentionRate / 100));
          }
        }

        const remainingDays = days % 30;
        if (remainingDays > 0) {
          cumulativeProfit -= (safeMonthlyRetainer / 30) * remainingDays;
        }

        const commission = cumulativeProfit * (commissionRate / 100);
        const netProfit = cumulativeProfit - commission;
        const roi = initialCost !== 0 ? (netProfit / initialCost) * 100 : 0;

        return {
          profit: Math.round(netProfit),
          roi: Math.round(roi),
          customersServed: Math.round(customersServed),
          activeCustomers: Math.round(activeCustomers),
          commission: Math.round(commission),
          monthlyRetainerPaid: Math.round(safeMonthlyRetainer * monthsPassed + (safeMonthlyRetainer / 30) * remainingDays)
        };
      }, [leadsPackage, customLeads, customCost, conversionRate, closeRate, profitPerLead, leadsPerDay, retentionRate, monthlyRetainer]);

      const updateChart = useCallback(() => {
        const ctx = chartRef.current?.getContext('2d');
        if (!ctx) return;

        if (chartInstance.current) {
          chartInstance.current.destroy();
        }

        const days = chartRange; // Use the selected chart range
        const profitData = [];
        const customersServedData = [];

        for (let i = 0; i <= days; i++) {
          const result = calculateForDays(i);
          profitData.push(result.profit);
          customersServedData.push(result.customersServed);
        }

        chartInstance.current = new Chart(ctx, {
          type: 'line',
          data: {
            labels: Array.from({length: days + 1}, (_, i) => `Day ${i}`),
            datasets: [
              {
                label: 'Profit ($)',
                data: profitData,
                borderColor: '#4CAF50',
                backgroundColor: 'rgba(76, 175, 80, 0.1)',
                yAxisID: 'y',
                stepped: false,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 2,
              },
              {
                label: 'Customers Served',
                data: customersServedData,
                borderColor: '#2196F3',
                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                yAxisID: 'y1',
                stepped: false,
                tension: 0.4,
                pointRadius: 0,
                borderWidth: 2,
              },
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                ticks: {
                  callback: function(value, index) {
                    return [0, Math.floor(days/3), Math.floor(2*days/3), days].includes(index) ? `Day ${index}` : '';
                  },
                  maxRotation: 0,
                  autoSkip: false,
                }
              },
              y: {
                type: 'linear',
                display: true,
                position: 'left',
                title: {
                  display: true,
                  text: 'Profit ($)'
                }
              },
              y1: {
                type: 'linear',
                display: true,
                position: 'right',
                title: {
                  display: true,
                  text: 'Customers Served'
                },
                grid: {
                  drawOnChartArea: false,
                }
              }
            },
            plugins: {
              tooltip: {
                mode: 'index',
                intersect: false,
              },
              legend: {
                position: 'top',
              }
            },
          }
        });
      }, [calculateForDays, chartRange]); // Add chartRange to the dependency array

      const handleRangeChange = (e) => {
        const newRange = parseInt(e.target.value);
        setChartRange(newRange);
        updateChart(); // Call updateChart directly after changing the range
      };

      const calculateROI = useCallback(() => {
        const results = {
          30: calculateForDays(30),
          60: calculateForDays(60),
          90: calculateForDays(90),
        };

        const dailyLeads = Number(leadsPerDay) || 1;
        const dailyCustomers = Math.max(0, Math.floor(dailyLeads * conversionRate));
        const totalNewCustomersServed = dailyCustomers * 60;

        // Calculate 60-day profit
        const sixtyDayProfit = results[60].profit;

        // Calculate 60-day cost to us (including retainer, commission, and package cost)
        const retainerCost = monthlyRetainer * 2; // 2 months
        const commissionCost = leadsPackage === 'custom' ? results[60].commission : 0;
        const packageCost = leadsPackage === 'custom' ? customCost : (leadsPackage === '5555' ? 10000 : 2000);
        const sixtyDayCostToUs = retainerCost + commissionCost + packageCost;

        // Calculate 60-day ROI
        const sixtyDayROI = ((sixtyDayProfit - sixtyDayCostToUs) / sixtyDayCostToUs) * 100;

        setStats({
          dailyProfit: Math.round(results[30].profit / 30),
          lifetimeValue: Math.round(profitPerLead * (1 / (1 - (retentionRate / 100)))),
          totalNewCustomersServed,
          activeCustomers: results[60].activeCustomers,
          sixtyDayProfit,
          sixtyDayROI,
          sixtyDayCostToUs,
          commission: commissionCost,
        });

        updateChart();
      }, [calculateForDays, updateChart, profitPerLead, retentionRate, leadsPerDay, conversionRate, monthlyRetainer, leadsPackage, customCost]);

      useEffect(() => {
        calculateROI();
      }, [calculateROI, chartRange]); // Add chartRange to the dependency array

      return (
        <div className="roi-calculator">
          <h2>Lead System ROI Calculator</h2>
          <div className="title-spacer"></div>
          <div className="input-section">
            <div className="input-group">
              <label htmlFor="leadsPackage">Lead Package:</label>
              <div className="input-control">
                <select
                  id="leadsPackage"
                  value={leadsPackage}
                  onChange={(e) => {
                    setLeadsPackage(e.target.value);
                    if (e.target.value !== 'custom') {
                      setCustomLeads(0); // Reset custom leads
                      setCustomCost(0); // Reset custom cost
                    }
                  }}
                >
                  <option value="5555">5,555 Leads - $10,000</option>
                  <option value="1000">1,000 Leads - $2,000</option>
                  <option value="custom">Custom Package</option>
                </select>
              </div>
            </div>

            {leadsPackage === 'custom' && (
              <>
                <div className="input-group">
                  <label htmlFor="customLeads">Custom Leads:</label>
                  <div className="input-control">
                    <input
                      type="number"
                      id="customLeads"
                      value={customLeads}
                      onChange={(e) => setCustomLeads(parseInt(e.target.value))}
                    />
                  </div>
                </div>

                <div className="input-group">
                  <label htmlFor="customCost">Custom Cost:</label>
                  <div className="input-control">
                    <input
                      type="number"
                      id="customCost"
                      value={customCost}
                      onChange={(e) => setCustomCost(parseInt(e.target.value))}
                    />
                  </div>
                </div>
              </>
            )}

            <div className="section-divider"></div>

            <div className="input-group">
              <label htmlFor="conversionRate">Conversion Rate:</label>
              <div className="input-control">
                <input
                  type="range"
                  id="conversionRate"
                  min="1"
                  max="25"
                  step="0.1"
                  value={conversionRate}
                  onChange={(e) => setConversionRate(parseFloat(e.target.value))}
                />
                <span className="slider-value">{conversionRate.toFixed(1)}%</span>
              </div>
            </div>

            <div className="input-group">
              <label htmlFor="closeRate">Close Rate:</label>
              <div className="input-control">
                <input
                  type="range"
                  id="closeRate"
                  min="1"
                  max="100"
                  step="1"
                  value={closeRate}
                  onChange={(e) => setCloseRate(parseInt(e.target.value))}
                />
                <span className="slider-value">{closeRate}%</span>
              </div>
            </div>

            <div className="section-divider"></div>

            <div className="input-group">
              <label htmlFor="profitPerLead">Profit per Lead ($):</label>
              <div className="input-control">
                <input
                  type="number"
                  id="profitPerLead"
                  value={profitPerLead}
                  onChange={(e) => setProfitPerLead(parseInt(e.target.value))}
                  min="0"
                />
              </div>
            </div>

            <div className="input-group">
              <label htmlFor="leadsPerDay">Leads Processed per Day:</label>
              <div className="input-control">
                <input
                  type="number"
                  id="leadsPerDay"
                  value={leadsPerDay}
                  onChange={(e) => setLeadsPerDay(parseInt(e.target.value))}
                  min="1"
                  max="1000"
                />
              </div>
            </div>

            <div className="section-divider"></div>

            <div className="input-group">
              <label htmlFor="retentionRate">Monthly Retention Rate:</label>
              <div className="input-control">
                <input
                  type="range"
                  id="retentionRate"
                  min="0"
                  max="100"
                  step="1"
                  value={retentionRate}
                  onChange={(e) => setRetentionRate(parseInt(e.target.value))}
                />
                <span className="slider-value">{retentionRate}%</span>
              </div>
            </div>

            <div className="input-group">
              <label htmlFor="monthlyRetainer">Monthly Retainer ($):</label>
              <div className="input-control">
                <input
                  type="number"
                  id="monthlyRetainer"
                  value={monthlyRetainer}
                  onChange={(e) => setMonthlyRetainer(parseInt(e.target.value))}
                  min="0"
                />
              </div>
            </div>

            <div className="input-group">
              <label htmlFor="chartRange">Select Chart Range (Days):</label>
              <div className="input-control">
                <select id="chartRange" value={chartRange} onChange={handleRangeChange}>
                  <option value={30}>30 Days</option>
                  <option value={60}>60 Days</option>
                  <option value={90}>90 Days</option>
                </select>
              </div>
            </div>
          </div>
          <div className="graph-section">
            <canvas id="roiChart" ref={chartRef}></canvas>
          </div>
          <div className="stats-section">
            <h3>Performance Statistics</h3>
            <div className="stats">
              <div className="stat-item">
                <span>Potential Daily Profit</span>
                <span className="stat-value">${stats.dailyProfit?.toLocaleString()}</span>
              </div>
              <div className="stat-item">
                <span>Customer Lifetime Value</span>
                <span className="stat-value">${stats.lifetimeValue?.toLocaleString()}</span>
              </div>
              <div className="stat-item">
                <span>60-Day Profit</span>
                <span className="stat-value">${stats.sixtyDayProfit?.toLocaleString()}</span>
              </div>
              <div className="stat-item">
                <span>60-Day Cost to Us (Retainer + Commission + Package Cost)</span>
                <span className="stat-value">${stats.sixtyDayCostToUs?.toLocaleString()}</span>
              </div>
              {leadsPackage === 'custom' && (
                <div className="stat-item">
                  <span>60-Day Commission</span>
                  <span className="stat-value">${stats.commission?.toLocaleString()}</span>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.render(
      <ROICalculator />,
      document.getElementById('roi-calculator-root')
    );
  </script>
</body>

</html>